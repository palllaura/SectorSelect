<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>SectorSelect</title>
    <style>
        body { font-family: system-ui, Avenir, Helvetica, Arial, sans-serif; padding: 24px; max-width: 820px; }
        h1 { font-size: large; }
        form { display: flex; flex-direction: column }
        label { font-size: small; display: block; margin-top: 12px; }
        .buttons { margin-top: 12px; margin-bottom: 12px; }
        .smallText { font-size: smaller }
    </style>
</head>
<body>
<h1>Please enter your name and pick the Sectors you are currently involved in.</h1>

<form id="sectorForm">
    <label for="nameInput">Name</label>
    <input id="nameInput" name="name" type="text" autocomplete="name"/>

    <label for="sectorSelect">Sectors</label>
    <select id="sectorSelect" multiple size="20" aria-label="Sectors"></select>

    <div>
        <label>
            <input id="agreeBox" type="checkbox"/>
            Agree to the terms
        </label>
    </div>

    <div class="buttons">
        <button type="button" onclick="sendSubmission()">Save</button>
    </div>
    <p class="smallText">You can edit your submission during the same browser session.</p>
</form>

<script>
    let currentSubmissionId = null;

    function addOptions(sectors) {
        const select = document.getElementById('sectorSelect');

        sectors.forEach(sector => {
            const option = document.createElement('option');
            option.value = sector.id;
            const indent = '\u00A0'.repeat(sector.level * 4);
            option.textContent = indent + sector.name;
            select.appendChild(option);

            if (sector.children && sector.children.length > 0) {
                addOptions(sector.children);
            }
        });
    }

    async function sendSubmission() {
        const select = document.getElementById('sectorSelect');
        const nameInput = document.getElementById('nameInput');
        const agreeBox = document.getElementById('agreeBox');
        const selectedIds = [];

        for (let i = 0; i < select.selectedOptions.length; i++) {
            selectedIds.push(select.selectedOptions[i].value)
        }

        if (!nameInput.value) {
            alert("Name field is mandatory");
            return;
        }
        else if (selectedIds.length < 1) {
            alert("Please select at least one sector");
            return;
        }
        else if (agreeBox.checked !== true) {
            alert("Please agree to terms");
            return;
        }

        const res = await fetch('http://localhost:8080/api/submission/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: nameInput.value,
                sectorIds: selectedIds,
                agree: agreeBox.checked,
                editSubmissionId: currentSubmissionId
            }),

        });
        const data = await res.json();

        console.log('res', res);
        console.log(data);

        currentSubmissionId = data.id;

        alert(`Submission saved. You can edit with id ${ currentSubmissionId }`)
    }

    async function loadData() {
        const res = await fetch('http://localhost:8080/api/sectors/tree');
        const data = await res.json();
        addOptions(data);
    }

    window.onload = loadData
</script>

</body>
</html>
